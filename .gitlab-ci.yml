---
stages:
  - build

variables:
  GIT_STRATEGY: empty

init sans bootstrap :
  stage: build
  tags:
    - windows
    - amd64
  before_script:
    - if [ -d "Gallus" ]; remove-item -path "C:\Gallus" -recurse -force
  allow_failure : true
  script:
    - ! "& ([scriptblock]::Create((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/Eternilab/gallus/main/gallus.ps1'))) gallus_download_tools"

build sans init :
  stage: build
  tags:
    - windows
    - amd64
  before_script:
    - if [ -d -path "C:\Gallus" ]; remove-item -path "C:\Gallus" -recurse -force
  allow_failure: true
  script:
    - New-Item -ItemType Directory -Force -Path "\Gallus"
    - cd \Gallus
    - Set-ExecutionPolicy Bypass -Scope Process -Force
    - "[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072"
    - "& ([scriptblock]::Create((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/Eternilab/gallus/main/gallus.ps1'))) -oneliner"
    - ! "& ([scriptblock]::Create((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/Eternilab/gallus/main/gallus.ps1'))) -build"


test iso:
  stage: build
  tags:
    - windows
    - amd64
  script:
    - powershell -Command "& {
        $isoPath = 'C:\Gallus\GMedia\LiteTouchMedia.iso';
        if (Test-Path $isoPath) {
          $diskImage = Get-DiskImage -ImagePath $isoPath -ErrorAction SlientlyContinue;
          if ($diskImage -and $diskImage.FileSystem -eq 'ISO 9660') {
            Write-Output 'Valid iso 9660 file';
            exit 0;
            } else {
              Write-Output 'Not a valid iso 9660 file';
              exit 1;
              } else {
                Write-output 'file not found';
              }
            }
            }"





bootstrap:
  stage: build
  tags:
    - windows
    - amd64
  before_script:
    - if [ -d -path "C:\Gallus" ]; remove-item -path "C:\Gallus" -recurse -force
  script:
    - New-Item -ItemType Directory -Force -Path "\Gallus"
    - cd \Gallus
    - Set-ExecutionPolicy Bypass -Scope Process -Force
    - "[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072"
    - "& ([scriptblock]::Create((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/Eternilab/gallus/main/gallus.ps1'))) -oneliner"
    - "& ([scriptblock]::Create((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/Eternilab/gallus/main/gallus.ps1'))) -full"
    
    
    
    
    
